!function e(t,n,r){function i(u,a){if(!n[u]){if(!t[u]){var y="function"==typeof require&&require;if(!a&&y)return y(u,!0);if(o)return o(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var s=n[u]={exports:{}};t[u][0].call(s.exports,function(e){var n=t[u][1][e];return i(n?n:e)},s,s.exports,e,t,n,r)}return n[u].exports}for(var o="function"==typeof require&&require,u=0;u<r.length;u++)i(r[u]);return i}({1:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t){r(this,e),this._ikm=t}return i(e,[{key:"sign",value:function(e){return crypto.subtle.importKey("raw",this._ikm,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then(function(t){return crypto.subtle.sign("HMAC",t,e)})}}]),e}();"undefined"!=typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.HMAC=o);var u=function(){function e(t,n){r(this,e),this._ikm=t,this._salt=n,this._hmac=new o(n)}return i(e,[{key:"generate",value:function(e,t){var n=new Uint8Array(e.byteLength+1);return n.set(e,0),n.set(new Uint8Array(1).fill(1),e.byteLength),this._hmac.sign(this._ikm).then(function(e){var t=new o(e);return t.sign(n)}).then(function(e){return e.slice(0,t)})}}]),e}();"undefined"!=typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.HKDF=u);var a=32,y=65,c=16,s=function(e){return e.reduce(function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n},new Uint8Array)},l=function(){function e(t,n){if(r(this,e),!t||!t.publicKey||!t.privateKey)throw new Error("Bad server keys. Use EncryptionHelperFactory.generateKeys()");if(!n)throw new Error("Bad salt value. Use EncryptionHelperFactory.generateSalt()");this._serverKeys=t,this._salt=n}return i(e,[{key:"getPublicServerKey",value:function(){return this._serverKeys.publicKey}},{key:"getPrivateServerKey",value:function(){return this._serverKeys.privateKey}},{key:"getSharedSecret",value:function(t){var n=this;return Promise.resolve().then(function(){return e.stringKeysToCryptoKeys(t)}).then(function(e){return e.publicKey}).then(function(e){if(!(e instanceof CryptoKey))throw new Error("The publicKey must be a CryptoKey.");var t={name:"ECDH",namedCurve:"P-256","public":e};return crypto.subtle.deriveBits(t,n.getPrivateServerKey(),256)})}},{key:"getSalt",value:function(){return this._salt}},{key:"generateContext",value:function(t){var n=this;return Promise.resolve().then(function(){return e.stringKeysToCryptoKeys(t)}).then(function(t){return e.exportCryptoKeys(t.publicKey).then(function(e){return e.publicKey})}).then(function(t){return e.exportCryptoKeys(n.getPublicServerKey()).then(function(e){return{clientPublicKey:t,serverPublicKey:e.publicKey}})}).then(function(e){var t=new TextEncoder("utf-8"),n=t.encode("P-256"),r=new Uint8Array(1).fill(0),i=new Uint8Array(2);i[0]=0,i[1]=e.clientPublicKey.byteLength;var o=new Uint8Array(2);return o[0]=0,o[1]=e.serverPublicKey.byteLength,s([n,r,i,e.clientPublicKey,o,e.serverPublicKey])})}},{key:"generateCEKInfo",value:function(e){var t=this;return Promise.resolve().then(function(){var n=new TextEncoder("utf-8"),r=n.encode("Content-Encoding: aesgcm"),i=new Uint8Array(1).fill(0);return t.generateContext(e).then(function(e){return s([r,i,e])})})}},{key:"generateNonceInfo",value:function(e){var t=this;return Promise.resolve().then(function(){var n=new TextEncoder("utf-8"),r=n.encode("Content-Encoding: nonce"),i=new Uint8Array(1).fill(0);return t.generateContext(e).then(function(e){return s([r,i,e])})})}},{key:"generatePRK",value:function(t){return this.getSharedSecret(t.keys.p256dh).then(function(n){var r=new TextEncoder("utf-8"),i=r.encode("Content-Encoding: auth\x00"),o=new u(n,e.base64UrlToUint8Array(t.keys.auth));return o.generate(i,32)})}},{key:"generateEncryptionKeys",value:function(e){var t=this;return Promise.all([this.generatePRK(e),this.generateCEKInfo(e.keys.p256dh),this.generateNonceInfo(e.keys.p256dh)]).then(function(e){var n=e[0],r=e[1],i=e[2],o=new u(n,t._salt),a=new u(n,t._salt);return Promise.all([o.generate(r,16),a.generate(i,12)])}).then(function(e){return{contentEncryptionKey:e[0],nonce:e[1]}})}},{key:"encryptMessage",value:function(t,n){var r=this;return this.generateEncryptionKeys(t).then(function(e){return crypto.subtle.importKey("raw",e.contentEncryptionKey,"AES-GCM",!0,["decrypt","encrypt"]).then(function(t){return e.contentEncryptionCryptoKey=t,e})}).then(function(e){var t=0,r=new Uint8Array(2+t),i=new TextEncoder("utf-8"),o=i.encode(n),u=new Uint8Array(r.byteLength+o.byteLength);u.set(r,0),u.set(o,r.byteLength);var a={name:"AES-GCM",tagLength:128,iv:e.nonce};return crypto.subtle.encrypt(a,e.contentEncryptionCryptoKey,u)}).then(function(t){return e.exportCryptoKeys(r.getPublicServerKey()).then(function(n){return{cipherText:t,salt:e.uint8ArrayToBase64Url(r.getSalt()),publicServerKey:e.uint8ArrayToBase64Url(n.publicKey)}})})}}],[{key:"exportCryptoKeys",value:function(t,n){return Promise.resolve().then(function(){var r=[];return r.push(crypto.subtle.exportKey("jwk",t).then(function(t){var n=e.base64UrlToUint8Array(t.x),r=e.base64UrlToUint8Array(t.y),i=new Uint8Array(65);return i.set([4],0),i.set(n,1),i.set(r,33),i})),n&&r.push(crypto.subtle.exportKey("jwk",n).then(function(t){return e.base64UrlToUint8Array(t.d)})),Promise.all(r)}).then(function(e){var t={publicKey:e[0]};return e.length>1&&(t.privateKey=e[1]),t})}},{key:"stringKeysToCryptoKeys",value:function(t,n){if("string"!=typeof t)throw new Error("The publicKey is expected to be an String.");var r=e.base64UrlToUint8Array(t);if(r.byteLength!==y)throw new Error("The publicKey is expected to be "+y+" bytes.");var i=new Uint8Array(r);if(4!==i[0])throw new Error("The publicKey is expected to start with an 0x04 byte.");var o={kty:"EC",crv:"P-256",x:e.uint8ArrayToBase64Url(i,1,33),y:e.uint8ArrayToBase64Url(i,33,65),ext:!0},u=[];if(u.push(crypto.subtle.importKey("jwk",o,{name:"ECDH",namedCurve:"P-256"},!0,[])),n){if("string"!=typeof n)throw new Error("The privateKey is expected to be an String.");var c=e.base64UrlToUint8Array(n);if(c.byteLength!==a)throw new Error("The privateKey is expected to be "+a+" bytes.");o.d=e.uint8ArrayToBase64Url(new Uint8Array(c)),u.push(crypto.subtle.importKey("jwk",o,{name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]))}return Promise.all(u).then(function(e){var t={publicKey:e[0]};return e.length>1&&(t.privateKey=e[1]),t})}},{key:"uint8ArrayToBase64Url",value:function(e,t,n){t=t||0,n=n||e.byteLength;var r=btoa(String.fromCharCode.apply(null,e.slice(t,n)));return r.replace(/\=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}},{key:"base64UrlToUint8Array",value:function(e){for(var t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),r=atob(n),i=new Uint8Array(r.length),o=0;o<r.length;++o)i[o]=r.charCodeAt(o);return i}}]),e}(),f=function(){function e(){r(this,e)}return i(e,null,[{key:"generateHelper",value:function(t){return Promise.resolve().then(function(){return t&&t.serverKeys?e.importKeys(t):e.generateKeys(t)}).then(function(e){var n=null;return n=t&&t.salt?l.base64UrlToUint8Array(t.salt):crypto.getRandomValues(new Uint8Array(16)),new l(e,n)})}},{key:"importKeys",value:function(e){return e&&e.serverKeys&&e.serverKeys.publicKey&&e.serverKeys.privateKey?Promise.resolve().then(function(){return l.stringKeysToCryptoKeys(e.serverKeys.publicKey,e.serverKeys.privateKey)}):Promise.reject(new Error("Bad options for key import"))}},{key:"generateKeys",value:function(){return crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"])}},{key:"generateSalt",value:function(){return crypto.getRandomValues(new Uint8Array(c))}}]),e}();"undefined"!=typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.EncryptionHelperFactory=f,window.gauntface.EncryptionHelper=l),t.exports=f},{}]},{},[1]);
//# sourceMappingURL=encryption-helper.js.map
