{"version":3,"sources":["scripts/push-client.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length","1","module","_classCallCheck","instance","Constructor","TypeError","_createClass","defineProperties","target","props","descriptor","enumerable","configurable","writable","Object","defineProperty","key","protoProps","staticProps","prototype","PushClient","stateChangeCb","subscriptionUpdate","_this","this","_stateChangeCb","_subscriptionUpdate","_state","UNSUPPORTED","id","interactive","pushEnabled","INITIALISING","PERMISSION_DENIED","PERMISSION_GRANTED","PERMISSION_PROMPT","ERROR","STARTING_SUBSCRIBE","SUBSCRIBED","STARTING_UNSUBSCRIBE","UNSUBSCRIBED","navigator","window","ServiceWorkerRegistration","serviceWorker","ready","then","setUpPushPermission","value","permissionState","console","error","_this2","_permissionStateChange","Notification","permission","serviceWorkerRegistration","pushManager","getSubscription","subscription","err","log","_this3","Promise","resolve","reject","requestPermission","result","subscribe","userVisibleOnly","subscriptionErr","_this4","pushSubscription","unsubscribe","successful"],"mappings":"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","file":"scripts/push-client.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\n/* eslint-env browser */\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar PushClient = function () {\n  function PushClient(stateChangeCb, subscriptionUpdate) {\n    var _this = this;\n\n    _classCallCheck(this, PushClient);\n\n    this._stateChangeCb = stateChangeCb;\n    this._subscriptionUpdate = subscriptionUpdate;\n\n    this._state = {\n      UNSUPPORTED: {\n        id: 'UNSUPPORTED',\n        interactive: false,\n        pushEnabled: false\n      },\n      INITIALISING: {\n        id: 'INITIALISING',\n        interactive: false,\n        pushEnabled: false\n      },\n      PERMISSION_DENIED: {\n        id: 'PERMISSION_DENIED',\n        interactive: false,\n        pushEnabled: false\n      },\n      PERMISSION_GRANTED: {\n        id: 'PERMISSION_GRANTED',\n        interactive: true\n      },\n      PERMISSION_PROMPT: {\n        id: 'PERMISSION_PROMPT',\n        interactive: true,\n        pushEnabled: false\n      },\n      ERROR: {\n        id: 'ERROR',\n        interactive: false,\n        pushEnabled: false\n      },\n      STARTING_SUBSCRIBE: {\n        id: 'STARTING_SUBSCRIBE',\n        interactive: false,\n        pushEnabled: true\n      },\n      SUBSCRIBED: {\n        id: 'SUBSCRIBED',\n        interactive: true,\n        pushEnabled: true\n      },\n      STARTING_UNSUBSCRIBE: {\n        id: 'STARTING_UNSUBSCRIBE',\n        interactive: false,\n        pushEnabled: false\n      },\n      UNSUBSCRIBED: {\n        id: 'UNSUBSCRIBED',\n        interactive: true,\n        pushEnabled: false\n      }\n    };\n\n    if (!('serviceWorker' in navigator)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    if (!('PushManager' in window)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    if (!('showNotification' in ServiceWorkerRegistration.prototype)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    navigator.serviceWorker.ready.then(function () {\n      _this._stateChangeCb(_this._state.INITIALISING);\n      _this.setUpPushPermission();\n    });\n  }\n\n  _createClass(PushClient, [{\n    key: '_permissionStateChange',\n    value: function _permissionStateChange(permissionState) {\n      // If the notification permission is denied, it's a permanent block\n      switch (permissionState) {\n        case 'denied':\n          this._stateChangeCb(this._state.PERMISSION_DENIED);\n          break;\n        case 'granted':\n          this._stateChangeCb(this._state.PERMISSION_GRANTED);\n          break;\n        case 'default':\n          this._stateChangeCb(this._state.PERMISSION_PROMPT);\n          break;\n        default:\n          console.error('Unexpected permission state: ', permissionState);\n          break;\n      }\n    }\n  }, {\n    key: 'setUpPushPermission',\n    value: function setUpPushPermission() {\n      var _this2 = this;\n\n      this._permissionStateChange(Notification.permission);\n\n      return navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n        // Let's see if we have a subscription already\n        return serviceWorkerRegistration.pushManager.getSubscription();\n      }).then(function (subscription) {\n        if (!subscription) {\n          // NOOP since we have no subscription and the permission state\n          // will inform whether to enable or disable the push UI\n          return;\n        }\n\n        _this2._stateChangeCb(_this2._state.SUBSCRIBED);\n\n        // Update the current state with the\n        // subscriptionid and endpoint\n        _this2._subscriptionUpdate(subscription);\n      }).catch(function (err) {\n        console.log(err);\n        _this2._stateChangeCb(_this2._state.ERROR, err);\n      });\n    }\n  }, {\n    key: 'subscribeDevice',\n    value: function subscribeDevice() {\n      var _this3 = this;\n\n      this._stateChangeCb(this._state.STARTING_SUBSCRIBE);\n\n      return new Promise(function (resolve, reject) {\n        if (Notification.permission === 'denied') {\n          return reject(new Error('Push messages are blocked.'));\n        }\n\n        if (Notification.permission === 'granted') {\n          return resolve();\n        }\n\n        if (Notification.permission === 'default') {\n          Notification.requestPermission(function (result) {\n            if (result !== 'granted') {\n              reject(new Error('Bad permission result'));\n            }\n\n            resolve();\n          });\n        }\n      }).then(function () {\n        // We need the service worker registration to access the push manager\n        return navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n          return serviceWorkerRegistration.pushManager.subscribe({ userVisibleOnly: true });\n        }).then(function (subscription) {\n          _this3._stateChangeCb(_this3._state.SUBSCRIBED);\n          _this3._subscriptionUpdate(subscription);\n        }).catch(function (subscriptionErr) {\n          _this3._stateChangeCb(_this3._state.ERROR, subscriptionErr);\n        });\n      }).catch(function () {\n        // Check for a permission prompt issue\n        _this3._permissionStateChange(Notification.permission);\n      });\n    }\n  }, {\n    key: 'unsubscribeDevice',\n    value: function unsubscribeDevice() {\n      var _this4 = this;\n\n      // Disable the switch so it can't be changed while\n      // we process permissions\n      // window.PushDemo.ui.setPushSwitchDisabled(true);\n\n      this._stateChangeCb(this._state.STARTING_UNSUBSCRIBE);\n\n      navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n        return serviceWorkerRegistration.pushManager.getSubscription();\n      }).then(function (pushSubscription) {\n        // Check we have everything we need to unsubscribe\n        if (!pushSubscription) {\n          _this4._stateChangeCb(_this4._state.UNSUBSCRIBED);\n          _this4._subscriptionUpdate(null);\n          return;\n        }\n\n        // TODO: Remove the device details from the server\n        // i.e. the pushSubscription.subscriptionId and\n        // pushSubscription.endpoint\n        return pushSubscription.unsubscribe().then(function (successful) {\n          if (!successful) {\n            // The unsubscribe was unsuccessful, but we can\n            // remove the subscriptionId from our server\n            // and notifications will stop\n            // This just may be in a bad state when the user returns\n            console.error('We were unable to unregister from push');\n          }\n        });\n      }).then(function () {\n        _this4._stateChangeCb(_this4._state.UNSUBSCRIBED);\n        _this4._subscriptionUpdate(null);\n      }).catch(function (err) {\n        console.error('Error thrown while revoking push notifications. ' + 'Most likely because push was never registered', err);\n      });\n    }\n  }]);\n\n  return PushClient;\n}();\n\nmodule.exports = PushClient;\n\n},{}]},{},[1]);\n"],"sourceRoot":"/source/"}